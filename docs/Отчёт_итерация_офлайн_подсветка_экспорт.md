# Отчёт: итерация P0/P1 — офлайн-карта, подсветка, экспорт снимка

**Дата:** 13.02.2025  
**Задачи:** P0 офлайн-карта, P1 подсветка пропусков/перекрытий, P1 экспорт изображения карты

---

## Результат: успех

### Сделано по каждому пункту

#### 1. P0: Офлайн-карта (offline-first)

**Реализовано:**
- При отсутствии сети используется локальный стиль: тёмный фон (#1a1a2e), без тайлов.
- В офлайн-режиме добавляются слои трека (полоса #4CAF50, пунктирная центральная линия) — карта и трек остаются рабочими без сети.
- Подписка на `Connectivity().onConnectivityChanged` — при потере сети переключаемся на офлайн-стиль, при появлении — на онлайн.
- Проверка сети при старте и при изменении — `_useOfflineStyle` обновляется динамически.

**Ограничения:**
- Кэширование тайлов MapLibre (ambient cache) работает при онлайн-просмотре, но при переключении на офлайн-стиль тайлы не отображаются — показывается тёмный фон.
- Для полноценного офлайна с тайлами потребуется предварительная загрузка региона (OfflineRegionDefinition) — отдельная задача.

**Fallback:** При отсутствии сети карта остаётся usable: AB-линия, трек, трактор, параллели отображаются поверх тёмного фона.

---

#### 2. P1: Подсветка пропусков/перекрытий на карте

**Реализовано:**
- В `MapLibreMapWidget` добавлен параметр `gapOverlapStatus`.
- При `GapOverlapStatus.gap` — полупрозрачный красный круг (#E53935) радиусом 4 м вокруг текущей позиции.
- При `GapOverlapStatus.overlap` — полупрозрачный жёлтый круг (#FDD835) радиусом 4 м.
- Подсветка обновляется при движении и при смене статуса.
- Баннер «Внимание: пропуск!» / «Перекрытие!» сохранён.

---

#### 3. P1: Экспорт изображения карты (снимок)

**Реализовано:**
- В меню «Поделиться» (главный экран) добавлен пункт «Снимок карты».
- В экране просмотра истории (TrackViewScreen) добавлена кнопка «Поделиться» в AppBar с пунктом «Снимок карты».
- Используется `RepaintBoundary` + `RenderRepaintBoundary.toImage(pixelRatio: 2.0)` → PNG → `Share.shareXFiles`.
- `ExportService.shareMapImage(Uint8List)` реализован для IO и Web.

**Ограничения (платформа):**
- На Android/iOS карта рендерится через platform view (TextureLayer). `RepaintBoundary.toImage()` может захватить пустую/чёрную область вместо карты. На Web результат зависит от реализации maplibre_gl_web.
- Fallback: при ошибке показывается SnackBar «Ошибка снимка: …».

---

### Изменённые файлы

| Файл | Изменения |
|------|-----------|
| `lib/widgets/maplibre_map_widget.dart` | Офлайн-слои при `_useOfflineStyle`, подписка на connectivity, `gapOverlapStatus`, `repaintBoundaryKey`, `_syncGapOverlapFill`, `RepaintBoundary` |
| `lib/screens/main_screen.dart` | `_mapRepaintKey`, `gapOverlapStatus`, `repaintBoundaryKey` в MapLibreMapWidget, «Снимок карты» в меню, `_captureAndShareMapImage` |
| `lib/screens/track_view_screen.dart` | `_mapRepaintKey`, `repaintBoundaryKey`, кнопка «Поделиться», `_showExportMenu`, `_captureAndShareMapImage` |
| `lib/services/export_service_io.dart` | `shareMapImage(Uint8List)` |
| `lib/services/export_service_web.dart` | `shareMapImage(Uint8List)` |

---

### Результаты analyze/test

- **dart analyze:** 84 info (prefer_const_constructors и др.), 0 errors, 0 warnings.
- **flutter test:** 69 тестов пройдено.

---

### Что осталось и почему

1. **Кэширование тайлов для офлайна** — требуется отдельная реализация загрузки региона (OfflineRegionDefinition) и управление им. MapLibre поддерживает это, но нужен UI и логика выбора области.
2. **Снимок карты на mobile** — platform view может не попадать в `RepaintBoundary.toImage()`. Для надёжного снимка нужен нативный API (например, `takeSnapshot` в maplibre, если появится).
3. **Подсветка сегментов трека** — сейчас подсвечивается только текущая позиция. Подсветка целых сегментов (пропуски/перекрытия по всему треку) потребует анализа всех проходов и отрисовки полигонов.

---

### Не сломано (проверено)

- Цвет полосы #4CAF50
- Центральный пунктир
- Кнопки +/− и «Найти меня»
- Просмотр истории (TrackViewScreen)
- Экспорт GPX/CSV/KML
