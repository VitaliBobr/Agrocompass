# Претензии по приложению Agrokilar

*Дата фиксации: 13 февраля 2025*
*Дата исправления: 13 февраля 2025* — все пункты устранены.

---

## 1. Камера не направлена по направлению движения трактора (режим фиксации)

**Описание:** В режиме фиксации камера должна быть ориентирована по направлению движения трактора (вид сзади/спереди по ходу). Сейчас направление неправильное.

**Требование:** Камера должна следовать за направлением движения (вектор GNSS).

**Код:** `lib/widgets/maplibre_map_widget.dart`
- `_updateCamera()` — строка 164: `bearing = widget.is3D ? widget.headingDegrees : 0.0`
- В 2D режиме `bearing` всегда 0, в 3D используется `headingDegrees`
- Нужно: bearing по направлению движения и в режиме follow (фиксации)

---

## 2. Цвет трека — белый вместо зелёного

**Описание:** Текущий цвет отрисовки трека — белый.

**Требование:** Трек должен быть **зелёным**.

**Код:**
- `lib/widgets/maplibre_map_widget.dart` — строки 456–458: `lineColor: '#ffffff'` (центральная линия трека)
- `lib/widgets/maplibre_map_widget.dart` — строки 484–489: `lineColor: '#ffffff'` (граница полосы)
- `lib/widgets/map_widget.dart` — строка 155: `color: Colors.white` (полилиния трека)

---

## 3. Трактор должен быть треугольником с направлением по вектору движения

**Описание:** Текущее отображение трактора не соответствует направлению.

**Требование:**
- Трактор отображать как **треугольник**
- Ориентация треугольника зависит от **направления движения**
- Направление — вектор из разницы координат GNSS (текущая — предыдущая позиция)

**Код:**
- `lib/widgets/maplibre_map_widget.dart` — строки 250–258: трактор рисуется как белый круг (`addCircle`)
- `lib/widgets/map_widget.dart` — строки 315–343: трактор — круг с иконкой `Icons.agriculture`
- Нужно: заменить на треугольник (Polygon/Path), направление — `bearingDegrees(prevLat, prevLon, lat, lon)` из `geo_utils.dart`

---

## 4. Подобие штанги — по направлению за трактором, а не боком

**Описание:** Элемент, похожий на штангу опрыскивателя, идёт боком относительно движения.

**Требование:** Штанга должна идти **по направлению за трактором** (вдоль вектора движения), а не перпендикулярно.

**Код:**
- `lib/widgets/maplibre_map_widget.dart` — `_boomBarPoints()` (строки 211–224): штанга строится **перпендикулярно** курсу (влево/вправо)
- `lib/widgets/map_widget.dart` — `_boomBarPoints()` (строки 195–207): то же
- Сейчас: линия [left, right] — поперёк движения
- Требуется: линия от трактора **назад** по направлению движения (центр — конец штанги сзади)

---

## 5. Дёрганное отображение / «телепортация»

**Описание:** Карта/трактор отображаются рывками, «глаз типится», создаётся ощущение телепортации.

**Требование:** Плавное отображение, без резких скачков позиции.

**Код:**
- `lib/widgets/maplibre_map_widget.dart` — `_renderTimer` (100 мс), `_updateCamera()` вызывается каждые 300 мс
- `moveCamera` вызывается напрямую без анимации — дискретные скачки
- Возможные причины: резкие обновления GNSS, отсутствие интерполяции/сглаживания позиции
- Решение: интерполяция позиции, `animateCamera` вместо `moveCamera`, или сглаживание (Lerp)

---

## 6. «Поделиться» не работает

**Описание:** Функция «Поделиться» не функционирует.

**Требование:** Реализовать рабочую функцию поделиться (экспорт/шаринг данных).

**Код:**
- `lib/screens/main_screen.dart` — `_showShareMenu()`, `_showShareMenuForSession()`
- `lib/services/export_service.dart` — `ExportService.exportGpx/Csv/Kml` — использует `dart:io` File
- **Проблема:** `dart:io` и `path_provider` ведут себя по-разному на **web**; share_plus на web может не поддерживать файлы
- Решение: условная компиляция для web (например, копирование в буфер обмена или альтернативный API)

**Ошибка на web:**
```
MissingPluginException(No implementation found for method getTemporaryDirectory on channel plugins.flutter.io/path_provider)
```
- `path_provider.getTemporaryDirectory()` не реализован на web — плагин отсутствует

---

## Приоритеты для исправления

| # | Проблема | Приоритет | Статус |
|---|----------|-----------|--------|
| 1 | Камера по направлению движения | Высокий | ✅ Исправлено |
| 2 | Цвет трека (зелёный) | Низкий | ✅ Исправлено |
| 3 | Трактор — треугольник с направлением | Высокий | ✅ Исправлено |
| 4 | Штанга по направлению за трактором | Высокий | ✅ Исправлено |
| 5 | Плавное отображение (без дёрганий) | Высокий | ✅ Исправлено |
| 6 | Поделиться | Средний | ✅ Исправлено |

## Исправления (13.02.2025)

1. **Камера:** `bearing` теперь используется в режиме follow и в 2D, и в 3D.
2. **Цвет трека:** центральная линия, граница и полигон — зелёный (#4CAF50).
3. **Трактор:** заменён круг на треугольник, направление по вектору GNSS (bearingDegrees).
4. **Штанга:** линия идёт от центра назад по направлению движения (center → back).
5. **Плавность:** сглаживание позиции (Lerp), animateCamera вместо moveCamera, интервал 200 ms.
6. **Поделиться на web:** исправлен условный экспорт (dart.library.io → io, иначе web).
