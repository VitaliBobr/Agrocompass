# Agrocompass — Курсоуказатель

Мобильное приложение для параллельного вождения сельхозтехники: AB-линии, отклонение от линии, запись трека полосой, карта, расчёт пути и площади, экспорт.

## Назначение

Приложение помогает трактористу ехать строго по прямой линии во время полевых работ. Водитель отмечает точки А и Б на поле, приложение рассчитывает отклонение от этой прямой и показывает, куда рулить. Трек отображается как полоса шириной захвата — видно, где уже проехали, где ещё нет.

## Возможности

- **Главный экран**: карта с AB-линией и полосой трека, шкала отклонения, большое число отклонения (м), GPS-статус, курс, кнопки «Новая линия» / «Выбрать», Старт/Стоп записи трека, путь (км) и площадь (га).
- **Создание AB-линии**: Точка А, Точка Б, название, ширина междурядья (м), площадь поля (опционально), сохранение.
- **Список линий**: выбор линии, редактирование названия/ширины/площади, удаление (с подтверждением).
- **История работ**: список сессий с датой, длительностью, путём и площадью; экспорт трека в GPX, CSV, KML (поделиться).
- **Демо-режим**: симуляция движения без GPS; управление клавиатурой (стрелки / WASD) при удержании клавиш.
- **Офлайн**: данные хранятся локально (SQLite); карта использует OpenStreetMap (при первом просмотре нужен интернет для тайлов).

## Требования

- [Flutter](https://flutter.dev/docs/get-started/install) SDK >= 3.0.0
- Dart >= 3.0.0
- Android / iOS / Web / Windows / Linux / macOS (поддержка зависит от платформы)

## Быстрый старт

```bash
# Клонировать или открыть проект
cd Agrokilar

# Зависимости
flutter pub get

# Запуск (укажите устройство: -d chrome, -d windows и т.п. или подключённый телефон)
flutter run
```

## Команды

| Команда | Описание |
|---------|----------|
| `flutter pub get` | Установить зависимости |
| `flutter analyze` | Статический анализ кода |
| `flutter test` | Запуск тестов |
| `flutter run` | Запуск приложения |
| `flutter run -d chrome` | Запуск в браузере (web) |
| `flutter run -d windows` | Запуск в Windows |

## Структура папок

```
lib/
├── main.dart              # Точка входа, MaterialApp
├── screens/               # Экраны (навигация)
│   ├── main_screen.dart       # Главный экран с картой, записью
│   ├── create_ab_line_screen.dart
│   ├── ab_lines_list_screen.dart
│   ├── work_history_screen.dart
│   └── compass_screen.dart
├── widgets/               # Переиспользуемые виджеты
│   ├── maplibre_map_widget.dart  # Карта MapLibre
│   ├── deviation_bar.dart       # Шкала отклонения
│   ├── big_deviation_number.dart
│   ├── gps_status.dart
│   └── gnss_log_sheet.dart
├── services/              # Бизнес-логика
│   ├── location_service.dart    # GPS, демо
│   ├── track_recorder_service.dart
│   ├── guidance_calculator.dart
│   ├── export_service.dart      # Экспорт GPX/CSV/KML
│   ├── demo_gnss_simulation.dart
│   └── gap_overlap_detector.dart
├── models/                # Модели данных
│   ├── ab_line.dart
│   ├── work_session.dart
│   └── track_point.dart
├── repository/            # Доступ к данным
│   └── app_repository.dart
├── database/              # SQLite (io) и заглушки (web)
│   ├── database_helper.dart
│   ├── database_helper_io.dart
│   └── database_helper_web.dart
└── utils/                 # Утилиты (гео, форматирование)
```

## GNSS и демо-режим

- **Реальный GPS**: геолокация через `geolocator`, обновление ~10 Гц, фильтрация по точности (<5 м).
- **Демо-режим**: переключатель «Демо» на главном экране. Симуляция движения по маршруту A→B→A (или по выбранной линии). На web/десктопе можно включить «Клавиатура» — управление стрелками или WASD (**удержание** клавиши = движение).
- **Журнал GPS**: кнопка «Журнал GPS» открывает список последних записей позиции (для отладки).

## Разрешения

- **Android**: `ACCESS_FINE_LOCATION`, `ACCESS_COARSE_LOCATION`, `INTERNET` (уже в манифесте).
- **iOS**: в `ios/Runner/Info.plist` добавьте:
  ```xml
  <key>NSLocationWhenInUseUsageDescription</key>
  <string>Приложению нужен доступ к геолокации для курсоуказателя и записи трека.</string>
  <key>NSMotionUsageDescription</key>
  <string>Для отображения курса (компаса).</string>
  ```

## Зависимости

| Пакет | Назначение |
|-------|------------|
| geolocator | GPS |
| maplibre_gl | Карта (MapLibre) |
| sqflite, path_provider | Локальная БД |
| share_plus | Экспорт/поделиться |
| shared_preferences | Выбор текущей линии |
| flutter_compass | Курс |

## Troubleshooting

| Проблема | Решение |
|----------|---------|
| «НЕТ СИГНАЛА GPS» | Включите геолокацию, дайте разрешение приложению. Или включите «Демо» для проверки без GPS. |
| Поделиться не работает на web | На web экспорт использует альтернативный путь (XFile); на некоторых браузерах share может быть ограничен. |
| Карта не загружается | Нужен интернет для первой загрузки тайлов. При отсутствии сети отображается минимальный стиль. |
| `flutter analyze` показывает ошибки | Исправьте согласно подсказкам; при необходимости обновите `analysis_options.yaml`. |

## Документация

- [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) — архитектура модулей и потоков данных
- [docs/DEVELOPMENT.md](docs/DEVELOPMENT.md) — процесс разработки, стиль, проверки
- [docs/ТЗ_Курсоуказатель_Полное.md](docs/ТЗ_Курсоуказатель_Полное.md) — полное техническое задание
