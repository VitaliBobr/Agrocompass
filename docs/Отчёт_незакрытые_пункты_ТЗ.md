# Отчёт: незакрытые пункты ТЗ «Курсоуказатель»

**Дата:** 13.02.2025  
**Источник:** docs/ТЗ_Курсоуказатель_Полное.md  
**Фокус:** карта/трек, UX, офлайн, производительность, история, экспорт.

---

## 1. Незакрытые пункты ТЗ (по приоритету)

### P0 — Критичные (блокируют соответствие ТЗ)

| № | Пункт ТЗ | Описание проблемы |
|---|----------|-------------------|
| 1 | **1.3.9 Офлайн-карта** | ТЗ: «кэширование или простая сетка». Сейчас при отсутствии сети — только тёмный фон без тайлов. Кэширование тайлов не реализовано. |
| 2 | **11 «Можно открыть старый трек»** | Нет экрана просмотра выбранной сессии на карте. История показывает список и экспорт, но нельзя открыть конкретную сессию и увидеть её трек на карте. |

### P1 — Важные (прямые требования ТЗ)

| № | Пункт ТЗ | Описание проблемы |
|---|----------|-------------------|
| 3 | **5.2 Цвет заливки полосы** | ТЗ: полупрозрачный зелёный (#4CAF50, 30–40%). В коде — жёлтый (#FFD600, #FFEB3B). |
| 4 | **5.2 Граница полосы** | ТЗ: тонкая белая или чёрная линия по краям. В коде — жёлтая (#FFEB3B). |
| 5 | **5.2 Центральная линия** | ТЗ: пунктирная линия по центру полосы. Не реализована. |
| 6 | **5.7 Подсветка на карте** | ТЗ: пропуск — подсветка области красным; перекрытие — жёлтым. Сейчас только баннер «Внимание: пропуск!» / «Перекрытие!», подсветки на карте нет. |
| 7 | **5.8 Кнопки масштаба** | ТЗ: жест «щипок» и/или кнопки «+» / «−». Щипок есть (MapLibre), кнопок «+»/«−» нет. |
| 8 | **10.1 Изображение карты** | ТЗ: «Изображение карты — кнопка «Поделиться»». Экспорт GPX/CSV/KML есть; скриншот/экспорт карты — нет. |

### P2 — Желательные (улучшения)

| № | Пункт ТЗ | Описание проблемы |
|---|----------|-------------------|
| 9 | **2.1.C Количество спутников** | GpsStatus поддерживает satelliteCount, но main_screen не передаёт (geolocator не даёт). |
| 10 | **3.1 Фильтрация: скачок > 10 м** | ТЗ: игнорировать точку при скачке > 10 м за 1 с. Не реализовано. |
| 11 | **3.1 Интерполяция** | ТЗ: при потере GPS 2–3 с продолжать трек с учётом прежней скорости и курса. Частично есть в location_service (_predictPosition), но не при полной потере. |
| 12 | **10.2 Данные в отчёте** | ТЗ: средняя и максимальная скорость, ID техники, механизатора, поле/культура. CSV содержит только время, координаты, скорость, курс, отклонение — без сводки. |
| 13 | **8.3 Энергопотребление** | ТЗ: отключение GPS при уходе в фон. Не проверено. |
| 14 | **5.9 Производительность** | ТЗ: не тормозить при 10 000+ точек, упрощать трек. Нет явного упрощения/редукции точек. |
| 15 | **5.2 «Хвост»** | ТЗ: показ последних точек трека (например, за 10 с). Не реализовано отдельно. |

---

## 2. Где править (файл + кратко что)

| Пункт | Файл | Что сделать |
|-------|------|-------------|
| **P0-1 Офлайн-карта** | `lib/widgets/maplibre_map_widget.dart` | Добавить кэширование тайлов (maplibre_gl cache или свой слой) или использовать offline-first стиль с локальными тайлами. |
| **P0-2 Открыть старый трек** | `lib/screens/work_history_screen.dart`, новый экран | Добавить нажатие на сессию → переход на экран просмотра трека на карте (передать sessionId, загрузить точки, отрисовать на MapLibre). |
| **P1-3 Цвет полосы** | `lib/widgets/maplibre_map_widget.dart` | В `_syncTrack`, FillLayerProperties: `fillColor: '#4CAF50'`, `fillOpacity: 0.35`. Линия трека — тоже зелёный. |
| **P1-4 Граница полосы** | `lib/widgets/maplibre_map_widget.dart` | В `_trackBorders` LineOptions: `lineColor: '#FFFFFF'` или `'#000000'`. |
| **P1-5 Центральная линия** | `lib/widgets/maplibre_map_widget.dart` | Добавить слой пунктирной линии по центру полосы (середина между left/right полигона). |
| **P1-6 Подсветка пропуск/перекрытие** | `lib/widgets/maplibre_map_widget.dart`, `lib/screens/main_screen.dart` | Передавать `GapOverlapStatus` в карту; при gap/overlap рисовать полигон/маркер красным/жёлтым в зоне текущей позиции. |
| **P1-7 Кнопки +/-** | `lib/screens/main_screen.dart` или `lib/widgets/maplibre_map_widget.dart` | Добавить FAB/кнопки «+» и «−» над картой, вызывать `controller.animateCamera(CameraUpdate.zoomIn/Out)`. |
| **P1-8 Изображение карты** | `lib/screens/main_screen.dart`, `lib/services/export_service*.dart` | Добавить в меню «Поделиться» пункт «Снимок карты»; использовать `RepaintBoundary` + `toImage()` + share. |
| **P2-9 Спутники** | `lib/services/location_service.dart`, `lib/screens/main_screen.dart` | Если есть API (например, `geolocator` + native или `flutter_gps`), передавать satelliteCount в GpsStatus. Иначе — оставить как опционально. |
| **P2-10 Скачок > 10 м** | `lib/services/location_service.dart` | В `_emitRealOutputTick` / перед `_controller.add`: проверить расстояние до предыдущей точки; если > 10 м за 1 с — не эмитить. |
| **P2-12 Отчёт** | `lib/services/export_service_common.dart` | В CSV/GPX добавить заголовок с датой, длительностью, путём, площадью, средней/макс скоростью. |
| **P2-14 Производительность** | `lib/services/track_recorder_service.dart`, `lib/widgets/maplibre_map_widget.dart` | Douglas–Peucker или ограничение точек при отрисовке; загрузка сегментов порциями. |

---

## 3. Закрытые стабильно

| Пункт ТЗ | Реализация |
|----------|------------|
| **2.1.A** Индикатор отклонения (шкала, зелёная середина, красные края) | `DeviationBar` |
| **2.1.B** Большое число отклонения (80+ sp), цвет по величине, знак ± | `BigDeviationNumber` (96 sp) |
| **2.1.C** Точность GPS | `GpsStatus` показывает «Точность: X.X м» |
| **2.1.D** Кнопки «Новая линия», «Выбрать линию» | `main_screen.dart` |
| **2.1.E** Старт/Стоп записи, мигающая красная точка | `_RecordingIndicator` |
| **2.1.F** Компас/курс | Курс в градусах, FlutterCompass |
| **2.1.G** Карта ≥40% экрана | `MapLibreMapWidget`, flex: 5 |
| **2.1.H** Путь (км), площадь (га), обновление в реальном времени | `TrackRecorderService`, formatDistanceKm, formatAreaHa |
| **2.1.I** Процент выполнения (totalAreaHa, %, прогресс-бар) | `_PercentProgress` |
| **2.2** Создание AB-линии (А, Б, название, ширина, сброс, сохранение) | `CreateAbLineScreen` |
| **2.3** Список линий (выбор, долгое нажатие = удалить, редактирование, длина) | `AbLinesListScreen` |
| **2.4** История работ (дата, название, длительность, путь, площадь) | `WorkHistoryScreen` |
| **3.1** GPS 1 Гц+, точность <5 м (игнорировать) | `location_service.dart` |
| **3.1** Фильтр скорости >0.5 км/ч для пути | `track_recorder_service.dart` |
| **3.2** Расчёт отклонения с учётом направления | `GuidanceCalculator`, `geo_utils` |
| **3.3** Сохранение AB-линий, сессий, точек | SQLite, `database_helper_io` |
| **3.4** «НЕТ СИГНАЛА GPS» на весь экран | Полноэкранный оверлей |
| **3.4** Потеряна линия | Диалог «Линия не найдена» + «Выбрать линию» |
| **3.4** Нет прав — кнопка «Настройки» | `_location.openAppSettings()` |
| **4.1** Цветовая схема (тёмный фон, белый/зелёный, красный) | `Color(0xFF121212)` и т.д. |
| **5.1** Трек как полоса | `_buildStripPolygon`, ширина = widthMeters |
| **5.3** AB-линия жёлтая, параллели, текущая позиция | `_syncAbAndParallels`, трактор-треугольник |
| **5.4–5.5** Расчёт пути и площади | `track_recorder_service` |
| **5.7** Детекция пропусков/перекрытий | `GapOverlapDetector`, баннеры |
| **5.8** «Найти меня» / следовать за трактором | Кнопка gps_fixed, режим follow |
| **5.8** Режим следования (угол камеры = курс) | `bearing = headingDegrees` при follow |
| **5.8** Перемещение, масштаб (щипок) | MapLibre жесты |
| **6.1** Демо, клавиатура (удержание) | `DemoGnssSimulation`, `_handleKeyEvent` |
| **10.1** Экспорт GPX, CSV, KML | `ExportService` |
| **10.1** Кнопка «Поделиться» | Меню экспорта на главном экране и в истории |

---

## 4. Краткая сводка

- **P0:** 2 пункта (офлайн-карта, открыть старый трек).
- **P1:** 6 пунктов (цвет полосы, граница, центральная линия, подсветка на карте, кнопки +/-, снимок карты).
- **P2:** 7 пунктов (спутники, фильтры GPS, отчёт, энергопотребление, производительность, хвост).

**Стабильно закрыто:** ~35 пунктов ТЗ (основной функционал курсоуказателя, карта, трек, история, экспорт).
