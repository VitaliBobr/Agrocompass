# План доведения Agrokilar до полного соответствия ТЗ

**Дата:** 13.02.2025  
**Основа:** docs/ТЗ_Курсоуказатель_Полное.md  
**Проблемы пользователя:** трек, заливка, лаги, ширина захвата

---

## P0 — Критичные (блокируют работу в поле)

### P0-1. Трек: запись, сохранение, отображение

**Проблема:** Трек не записывается, не сохраняется или не отображается корректно.

**Критерии приёмки:**
- [ ] При нажатии СТАРТ точки пишутся в БД (скорость > 0.5 км/ч)
- [ ] При СТОП сессия сохраняется, трек виден в истории
- [ ] При перезапуске приложения трек остаётся
- [ ] На карте полоса трека отображается (не пусто)

**Агент:** autonomous-developer → verifier

---

### P0-2. Ширина захвата: применение и отображение

**Проблема:** Ширина полосы не соответствует заданной или не применяется.

**Критерии приёмки:**
- [ ] При создании линии вводится «ширина междурядья» (м) — поле есть и сохраняется
- [ ] Полоса трека на карте имеет ширину = widthMeters выбранной AB-линии
- [ ] Площадь (га) = путь (м) × ширина (м) / 10000
- [ ] При просмотре истории сессии используется widthMeters сессии (или AB-линии на момент записи)

**Агент:** autonomous-developer → verifier

---

### P0-3. Заливка полосы: цвет и видимость по ТЗ

**Проблема:** Цвет заливки не соответствует ТЗ (жёлтый вместо зелёного), заливка нестабильна.

**Критерии приёмки:**
- [ ] Цвет заливки: полупрозрачный зелёный #4CAF50, 30–40% прозрачности (ТЗ 5.2)
- [ ] Граница полосы: тонкая белая или чёрная линия по краям
- [ ] Полоса стабильно отображается при записи и при просмотре истории

**Файлы:** `maplibre_map_widget.dart`, `map_widget.dart`

**Агент:** fixer → verifier

---

## P1 — Важные (влияют на удобство)

### P1-1. Лаги и производительность

**Проблема:** Приложение тормозит при длинных треках или при записи.

**Критерии приёмки:**
- [ ] При 5000+ точках карта остаётся отзывчивой (ТЗ 7.2)
- [ ] Нет заметных фризов при обновлении позиции (1 Гц GPS)
- [ ] Рисуется только видимая область / упрощение трека при большом zoom out

**Рекомендации ТЗ 5.9:** хранить в БД, рисовать видимое, упрощать трек (объединять близкие точки).

**Агент:** autonomous-developer → verifier

---

### P1-2. Пунктирная линия по центру полосы

**Проблема:** ТЗ 5.2 требует пунктирную линию по центру полосы — не реализовано.

**Критерии приёмки:**
- [ ] По центру полосы трека рисуется пунктирная линия (читаемая на карте)

**Агент:** fixer

---

### P1-3. Офлайн-карта

**Проблема:** ТЗ 1.3.9 — карта без интернета. Сейчас при отсутствии сети используется минимальный стиль.

**Критерии приёмки:**
- [ ] Без интернета карта отображает: AB-линию, трек, позицию, параллели
- [ ] Нет зависимости от тайлов при офлайн

**Агент:** autonomous-developer (если ещё не полностью реализовано)

---

## P2 — Желательные (полировка)

### P2-1. Процент выполнения (2.1.I)

**Критерии приёмки:**
- [ ] Ввод общей площади поля при создании/редактировании линии
- [ ] Отображение «X%» и прогресс-бар на главном экране

---

### P2-2. Пропуски и перекрытия (5.7)

**Статус:** GapOverlapDetector реализован. Проверить:
- [ ] Подсветка пропусков красным на карте (если требуется)
- [ ] Сообщения «Внимание, пропуск!» / «Перекрытие!» отображаются

---

### P2-3. Экспорт изображения карты (10.1)

**Критерии приёмки:**
- [ ] Кнопка «Поделиться» — экспорт GPX/CSV/KML работает на всех платформах
- [ ] Опционально: скриншот карты для шаринга

---

## Порядок выполнения для агентов

```
1. verifier     — прогон по ТЗ, выдача отчёта о текущем состоянии
2. autonomous-developer — P0-1 (трек), P0-2 (ширина захвата)
3. fixer        — P0-3 (заливка зелёная)
4. verifier     — проверка P0
5. autonomous-developer — P1-1 (лаги)
6. fixer        — P1-2 (пунктир по центру)
7. verifier     — финальная проверка P0+P1
8. tractor-driver-reviewer — оценка готовности к полю
```

---

## Краткие промпты для subagent

| Задача | Промпт |
|--------|--------|
| P0-1 | «Доведи запись и отображение трека до рабочего состояния. Точки при скорости >0.5 км/ч, сохранение в БД, полоса на карте. dart analyze + flutter test.» |
| P0-2 | «Ширина захвата: полоса трека = widthMeters из AB-линии. Площадь = путь × ширина / 10000. Проверь create_ab_line_screen и track_recorder.» |
| P0-3 | «Измени цвет заливки полосы трека на зелёный #4CAF50 (30–40% прозрачности), граница белая/чёрная. maplibre_map_widget, map_widget.» |
| P1-1 | «Оптимизируй отрисовку трека: при 5000+ точках не должно тормозить. Упрощение геометрии, throttle обновлений.» |
| P1-2 | «Добавь пунктирную линию по центру полосы трека (ТЗ 5.2).» |

---

## Чеклист финального контроля (ТЗ раздел 11)

- [ ] Механизатор видит на карте, где проехал (полоса)
- [ ] Ширина полосы = ширине захвата
- [ ] Считается пройденное расстояние
- [ ] Считается обработанная площадь
- [ ] Трек сохраняется после завершения работы
- [ ] Можно открыть старый трек
- [ ] Можно экспортировать трек
- [ ] Данные сохраняются после перезапуска
- [ ] Нет падений при длительной работе
- [ ] Карту можно перемещать и масштабировать
- [ ] Есть кнопка «Вернуться на мою позицию»
