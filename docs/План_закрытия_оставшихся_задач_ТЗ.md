# Исполнимый план закрытия ВСЕХ оставшихся задач по ТЗ

**Проект:** d:\Agrokilar  
**Дата:** 13.02.2025  
**Основа:** ТЗ_Курсоуказатель_Полное.md, АУДИТ_ТЗ_2025-02-13.md, План_доведения_до_ТЗ.md, Замечания_пользователя_для_разработчика.md

---

## Сводка оставшихся задач

| Приоритет | Кол-во | Источник |
|-----------|--------|----------|
| Critical | 1 | Цвет трека (жёлтый → зелёный) |
| High | 6 | Кнопки карты, открытие трека, производительность, пунктир |
| Medium | 4 | GPS-фильтры, шкала ≥30%, слои |
| Low | 2 | Подсказки, спутники |

---

## E1 — Цвет трека по ТЗ (Critical)

**Цель:** Привести визуализацию полосы трека в соответствие с ТЗ 5.2.

**Конкретные изменения:**
- `lib/widgets/maplibre_map_widget.dart`:
  - `fillColor: '#FFD600'` → `'#4CAF50'`, `fillOpacity: 0.85` → `0.35` (строки 753–754)
  - `lineColor: '#FFEB3B'` → `'#4CAF50'` для центральной линии трека (строка 599)
  - `lineColor: '#FFEB3B'` → `'#FFFFFF'` или `'#000000'` для границы полосы (строки 650, 659)
- `lib/widgets/map_widget.dart` (если используется): аналогично — зелёная заливка, белая/чёрная граница

**Критерии приёмки:**
- [ ] Заливка полосы: полупрозрачный зелёный #4CAF50, 30–40% прозрачности
- [ ] Граница полосы: тонкая белая или чёрная линия
- [ ] dart analyze — без ошибок

**Агент:** fixer

---

## E2 — Кнопки управления картой (High)

**Цель:** Реализовать ТЗ 5.8 — кнопки «+»/«−» для масштаба и «Найти меня» при выключенном follow.

**Конкретные изменения:**
- `lib/widgets/maplibre_map_widget.dart`:
  - Добавить callback `onZoomIn`, `onZoomOut`, `onCenterOnMe` (или передать `MapLibreMapController` в родителя)
  - В `build()`: `Stack` с `Positioned` кнопками поверх карты (правый нижний угол):
    - Кнопка «+» — `controller.moveCamera(CameraUpdate.zoomIn())`
    - Кнопка «−» — `controller.moveCamera(CameraUpdate.zoomOut())`
- `lib/screens/main_screen.dart`:
  - Добавить кнопку «Найти меня» (центрирование на текущей позиции), видимую при `_follow == false`
  - Либо: MapLibreMapWidget принимает `onCenterRequested` и при вызове выполняет `animateCamera` на текущую позицию

**Критерии приёмки:**
- [ ] Кнопки «+» и «−» масштабируют карту
- [ ] При follow=false есть кнопка «Найти меня» / «Моя позиция», центрирующая карту на тракторе
- [ ] dart analyze, flutter test — без ошибок

**Агент:** autonomous-developer

---

## E3 — Открытие старого трека на карте (High)

**Цель:** ТЗ 11 п.6 — «Можно открыть старый трек».

**Конкретные изменения:**
- `lib/screens/work_history_screen.dart`:
  - Добавить `onTap` на `ListTile` (или `InkWell`): при нажатии — переход на экран просмотра трека
- Создать `lib/screens/track_view_screen.dart` (или расширить `main_screen.dart`):
  - Принимает `sessionId` (и опционально `WorkSession`)
  - Загружает точки трека через `AppRepository.getTrackPointsBySessionId(sessionId)`
  - Отображает карту с полосой трека (без записи, без GPS-следования)
  - Использует `widthMeters` из сессии или AB-линии
- Навигация: `Navigator.push(context, MaterialPageRoute(builder: (_) => TrackViewScreen(sessionId: s.id)))`

**Критерии приёмки:**
- [ ] Tap по сессии в истории → открывается экран с картой и треком этой сессии
- [ ] Полоса трека отображается с правильной шириной (widthMeters)
- [ ] dart analyze, flutter test — без ошибок

**Агент:** autonomous-developer

---

## E4 — Производительность при длинных треках (High)

**Цель:** ТЗ 5.9, 7.2 — при 5000+ точках карта остаётся отзывчивой.

**Конкретные изменения:**
- `lib/services/track_recorder_service.dart` или `lib/utils/`:
  - Добавить функцию упрощения полигона (Douglas–Peucker или объединение близких точек)
- `lib/widgets/maplibre_map_widget.dart`:
  - В `_syncTrack()`: если `lineSegments` содержат суммарно > 3000–5000 точек — применить упрощение перед отрисовкой
  - Либо: `getVisibleTrackSegments()` в TrackRecorderService возвращает упрощённые сегменты при большом количестве точек

**Критерии приёмки:**
- [ ] При 5000+ точках карта не тормозит
- [ ] Визуально полоса трека остаётся читаемой (не теряется форма)
- [ ] dart analyze, flutter test — без ошибок

**Агент:** autonomous-developer

---

## E5 — Пунктирная линия по центру полосы (High)

**Цель:** ТЗ 5.2 — «Центральная линия: пунктирная линия по центру полосы».

**Конкретные изменения:**
- `lib/widgets/maplibre_map_widget.dart`:
  - В `_syncTrack()`: для каждого сегмента `lineSegments` центральная линия уже есть (`_trackLine`). Нужно изменить стиль на пунктирный.
  - MapLibre GL: `lineDasharray: [2, 4]` или аналог в LineOptions (если maplibre_gl поддерживает)
  - Если maplibre_gl не поддерживает dash — нарисовать центральную линию как отдельный Line с чередующимися короткими сегментами (упрощённая эмуляция пунктира)

**Критерии приёмки:**
- [ ] По центру полосы трека видна пунктирная линия
- [ ] dart analyze, flutter test — без ошибок

**Агент:** fixer

---

## E6 — GPS-фильтры (Medium)

**Цель:** ТЗ 3.1 — фильтрация точек по времени и скачку.

**Конкретные изменения:**
- `lib/services/location_service.dart`:
  - В `listen((Position position) {...})`: если `DateTime.now().difference(position.timestamp) > Duration(seconds: 3)` — `return` (не эмитить)
  - Добавить проверку: если `_prevRawUpdate != null`, вычислить расстояние между `_prevRawUpdate` и текущей позицией; если расстояние > 10 м и разница времени < 1.5 с — `return` (игнорировать скачок)

**Критерии приёмки:**
- [ ] Точки с timestamp старше 3 с не используются
- [ ] Скачки > 10 м за ~1 с отфильтровываются
- [ ] dart analyze, flutter test — без ошибок

**Агент:** fixer

---

## E7 — Шкала отклонения ≥30% ширины экрана (Medium)

**Цель:** ТЗ 2.1.A — «Минимальный размер: шкала занимает не менее 30% ширины экрана».

**Конкретные изменения:**
- `lib/widgets/deviation_bar.dart`:
  - Обернуть в `LayoutBuilder` (уже есть) и проверить: `final minW = MediaQuery.of(context).size.width * 0.3;` — если родитель даёт меньше, использовать `ConstrainedBox(minWidth: minW)` или `SizedBox(width: minW)` при необходимости
- `lib/screens/main_screen.dart`:
  - Убедиться, что `DeviationBar` получает достаточно места (например, `Expanded` с `flex` или `FractionallySizedBox`)

**Критерии приёмки:**
- [ ] Шкала занимает не менее 30% ширины экрана на типичных устройствах
- [ ] dart analyze — без ошибок

**Агент:** fixer

---

## E8 — Переключатель слоёв карты (Medium, опционально)

**Цель:** ТЗ 5.8 — «Переключение слоёв: трек, AB-линии, сетка параллелей».

**Конкретные изменения:**
- `lib/widgets/maplibre_map_widget.dart`:
  - Добавить параметры `showTrack`, `showAbLine`, `showParallels` (по умолчанию true)
  - При отрисовке условно показывать/скрывать соответствующие слои
- `lib/screens/main_screen.dart`:
  - Добавить чекбоксы или кнопки переключения слоёв (например, в overlay карты)

**Критерии приёмки:**
- [ ] Можно включить/выключить отображение трека, AB-линии, параллелей
- [ ] dart analyze — без ошибок

**Агент:** autonomous-developer (если время позволяет)

---

## E9 — Верификация и тесты

**Цель:** Убедиться, что все изменения не сломали приложение.

**Конкретные действия:**
- Запуск `dart analyze`
- Запуск `flutter test`
- Ручная проверка по чеклисту ТЗ раздел 11

**Критерии приёмки:**
- [ ] dart analyze — 0 issues
- [ ] flutter test — все тесты проходят
- [ ] Чеклист раздела 11 ТЗ выполнен

**Агент:** verifier

---

## E10 — Ревью тракториста

**Цель:** Финальная оценка готовности к полевым испытаниям.

**Конкретные действия:**
- Запуск приложения в демо-режиме
- Проверка: кнопки, надписи, удобство в поле
- Вердикт: готово / не готово

**Критерии приёмки:**
- [ ] Вердикт «Готово к полевым испытаниям» от tractor-driver-reviewer

**Агент:** tractor-driver-reviewer

---

## Порядок выполнения

```
E1 (fixer)           → цвет трека
E2 (autonomous-dev)  → кнопки карты
E3 (autonomous-dev)  → открытие старого трека
E4 (autonomous-dev)  → производительность
E5 (fixer)           → пунктир по центру
E6 (fixer)           → GPS-фильтры
E7 (fixer)           → шкала ≥30%
E8 (autonomous-dev)  → переключатель слоёв [опционально]
E9 (verifier)        → verify
E10 (tractor-driver) → финальный ревью
```

**Рекомендуемая последовательность:** E1 → E2 → E3 → E4 → E5 → E6 → E7 → E9. E8 — по возможности. E10 — после E9.

---

## Промпты для subagent

| Этап | Промпт |
|------|--------|
| E1 | «Измени цвет заливки полосы трека на зелёный #4CAF50 (30–40% прозрачности), граница белая/чёрная. Файлы: maplibre_map_widget.dart.» |
| E2 | «Добавь кнопки +/− для масштаба карты и кнопку «Найти меня» при выключенном follow. maplibre_map_widget, main_screen.» |
| E3 | «При tap по сессии в истории работ открывай экран с картой и треком этой сессии. work_history_screen, новый TrackViewScreen или передача sessionId в main.» |
| E4 | «При 5000+ точках трека карта не должна тормозить. Упрощение геометрии (Douglas–Peucker или объединение близких точек). track_recorder_service, maplibre_map_widget.» |
| E5 | «Добавь пунктирную линию по центру полосы трека (ТЗ 5.2). maplibre_map_widget.» |
| E6 | «Добавь GPS-фильтры: игнорировать точку если timestamp старше 3 с; игнорировать скачок >10 м за 1 с. location_service.dart.» |
| E7 | «Убедись, что шкала отклонения занимает не менее 30% ширины экрана. deviation_bar, main_screen.» |
| E8 | «Добавь переключатель слоёв: трек, AB-линия, параллели. maplibre_map_widget, main_screen.» |
| E9 | «Запусти dart analyze и flutter test. Проверь чеклист ТЗ раздел 11.» |
| E10 | «Оцени UI/UX Agrokilar с точки зрения тракториста. Вердикт: готово к полю или нет.» |

---

## Чеклист финального контроля (ТЗ раздел 11)

- [ ] Механизатор видит на карте, где проехал (полоса)
- [ ] Ширина полосы = ширине захвата
- [ ] Считается пройденное расстояние
- [ ] Считается обработанная площадь
- [ ] Трек сохраняется после завершения работы
- [ ] Можно открыть старый трек
- [ ] Можно экспортировать трек
- [ ] Данные сохраняются после перезапуска
- [ ] Нет падений при длительной работе
- [ ] Карту можно перемещать и масштабировать
- [ ] Есть кнопка «Вернуться на мою позицию»
