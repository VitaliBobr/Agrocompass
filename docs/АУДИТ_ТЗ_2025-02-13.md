# Аудит соответствия коду ТЗ (docs/ТЗ_Курсоуказатель_Полное.md)

**Дата:** 13.02.2025  
**Проект:** d:\Agrokilar

---

## 1. ЧТО УЖЕ РЕАЛИЗОВАНО

| Раздел ТЗ | Статус | Файлы |
|-----------|--------|-------|
| **2.1 Главный экран** | | |
| A. Индикатор отклонения (шкала) | ✓ | `lib/widgets/deviation_bar.dart` |
| B. Цифровое значение (80+ sp, цвет по зоне) | ✓ | `lib/widgets/big_deviation_number.dart` |
| C. Спутники/точность GPS | частично (только точность) | `lib/widgets/gps_status.dart` |
| D. AB-линия, кнопки Новая/Выбрать | ✓ | `lib/screens/main_screen.dart` |
| E. Старт/Стоп записи, мигающая точка | ✓ | `lib/screens/main_screen.dart` |
| F. Компас/курс | ✓ | `lib/screens/main_screen.dart` |
| G. Карта (≥40%) | ✓ | `lib/widgets/maplibre_map_widget.dart` |
| H. Путь (км), площадь (га) | ✓ | `lib/services/track_recorder_service.dart` |
| I. % выполнения | ✓ | `lib/screens/main_screen.dart` |
| **2.2 Создание AB-линии** | ✓ | `lib/screens/create_ab_line_screen.dart` |
| **2.3 Список линий** | ✓ | `lib/screens/ab_lines_list_screen.dart` |
| **2.4 История работ** | ✓ | `lib/screens/work_history_screen.dart` |
| **3.1 GPS** | частично | `lib/services/location_service.dart` |
| **3.2 Расчёт отклонения** | ✓ | `lib/services/guidance_calculator.dart` |
| **3.3 Сохранение** | ✓ | `lib/database/database_helper_io.dart` |
| **3.4 Ошибки (нет GPS, линия не найдена)** | ✓ | `lib/screens/main_screen.dart` |
| **5.1–5.4 Трек-полоса, путь, площадь** | ✓ | `lib/widgets/maplibre_map_widget.dart`, `track_recorder_service.dart` |
| **5.7 Пропуски/перекрытия** | ✓ | `lib/services/gap_overlap_detector.dart` |
| **5.8 Режим следования (bearing = heading)** | ✓ | `lib/widgets/maplibre_map_widget.dart` |
| **6.1 Клавиатура (удержание WASD/стрелки)** | ✓ | `lib/screens/main_screen.dart`, `lib/services/demo_gnss_simulation.dart` |
| **10.1 Экспорт GPX/CSV/KML** | ✓ | `lib/services/export_service*.dart` |

---

## 2. ЧТО НЕ РЕАЛИЗОВАНО / ЧАСТИЧНО / РЕГРЕССИЯ

### Блок трека (раздел 5)

| Требование | Проблема |
|------------|----------|
| **5.2 Цвет заливки** | ТЗ: полупрозрачный зелёный #4CAF50 (30–40%). Код: жёлтый #FFD600, 0.45 |
| **5.2 Центральная линия** | ТЗ: пунктирная линия по центру полосы. Не реализовано |
| **5.2 «Хвост»** | ТЗ: показ последних точек (за 10 с). Не реализовано |
| **5.9 Производительность** | Нет упрощения трека (Douglas–Peucker и т.п.) при 10 000+ точек |

### Карта и управление (5.8)

| Требование | Проблема |
|------------|----------|
| **Кнопки «+» / «−»** | ТЗ: жест щипок и/или кнопки. Кнопок нет, только жесты |
| **«Найти меня»** | Есть режим «Следовать», но нет отдельной кнопки центрирования при выключенном follow |
| **Переключение слоёв** | ТЗ: трек, AB-линии, сетка параллелей. Не реализовано |

### GPS и фильтрация (3.1)

| Условие ТЗ | Реализация |
|------------|------------|
| Точность хуже 5 м | ✓ Игнорируется |
| Прошло > 3 с с момента получения | ✗ Не проверяется |
| Скачок > 10 м за 1 с | ✗ Не фильтруется |
| Количество спутников | ✗ Не передаётся в GpsStatus (geolocator не даёт) |

### Прочее

| Требование | Проблема |
|------------|----------|
| **2.4 / 11 Открыть старый трек** | В истории только экспорт. Нет просмотра трека на карте |
| **2.1 Шкала ≥30% ширины** | Нужно проверить LayoutBuilder / constraints |

---

## 3. СПИСОК ПРАВОК (Critical / High / Medium)

### Critical

| # | Файл | Правка |
|---|------|--------|
| 1 | `lib/widgets/maplibre_map_widget.dart` | Цвет заливки трека: `fillColor: '#4CAF50'`, `fillOpacity: 0.35` (вместо #FFD600, 0.45) |
| 2 | `lib/widgets/maplibre_map_widget.dart` | Цвет границы/линии трека: зелёный #4CAF50 вместо #FFEB3B |
| 3 | `lib/widgets/map_widget.dart` | Аналогично: Polygon color `Color(0xFF4CAF50).withOpacity(0.35)` вместо жёлтого |

### High

| # | Файл | Правка |
|---|------|--------|
| 4 | `lib/widgets/maplibre_map_widget.dart` | Добавить кнопки «+» / «−» для масштаба (Positioned поверх карты) |
| 5 | `lib/widgets/maplibre_map_widget.dart` | Добавить кнопку «Найти меня» (центрирование при выключенном follow) |
| 6 | `lib/screens/work_history_screen.dart` | Добавить onTap по сессии → открыть карту с этим треком (или передать sessionId в MainScreen) |
| 7 | `lib/services/track_recorder_service.dart` | При 5000+ точек — упрощать полигон (Douglas–Peucker или объединение близких точек) перед отрисовкой |
| 8 | `lib/widgets/maplibre_map_widget.dart` | Добавить пунктирную центральную линию по оси полосы трека (ТЗ 5.2) |

### Medium

| # | Файл | Правка |
|---|------|--------|
| 9 | `lib/services/location_service.dart` | Фильтр: не эмитить точку, если `now - timestamp > 3 s` |
| 10 | `lib/services/location_service.dart` | Фильтр: игнорировать скачок > 10 м за 1 с (сравнить с предыдущей точкой) |
| 11 | `lib/widgets/deviation_bar.dart` | Убедиться, что шкала занимает ≥30% ширины (LayoutBuilder, minWidth) |
| 12 | `lib/widgets/maplibre_map_widget.dart` | Опционально: переключатель слоёв (трек / AB / параллели) — чекбоксы или кнопки |

---

## 4. КРАТКАЯ СВОДКА

- **Critical:** 3 правки (цвет трека по ТЗ — зелёный).
- **High:** 5 правок (кнопки карты, открытие старого трека, производительность, пунктир).
- **Medium:** 4 правки (фильтры GPS, шкала, слои).

Блок трека (заливка, ширина захвата, stop/start) в целом реализован; основное расхождение — цвет (жёлтый вместо зелёного). Пункты 5.8 и 6.1 (режим следования, клавиатура) реализованы.
